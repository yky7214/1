# Forecast-to-Fill (ftf_repro)

Reproduction codebase for the **Forecast-to-Fill** walk-forward gold-futures strategy.

This repository implements a **research-grade, fully out-of-sample** reproduction of a
Forecast-to-Fill style trading system, focusing on **engineering realism**:
execution timing, costs, impact, volatility targeting, and statistical validation.

The design follows a strict separation between **training** and **testing**, and is intended
to be iterated by changing parameters or code, repeatedly running:

> modify → backtest → inspect outputs → modify → backtest

until results converge toward the reference behavior.

---

## How to use this repository

- If you want to **reproduce the baseline results** → Sections **1–4**
- If you want to **stress-test robustness** (latency, cost, SPA) → Section **5**
- If you want to **study scalability / capacity** → Section **6**
- If you want to **generate final figures and statistics** → Section **7**

---

## Overview

Key properties of the implementation:

- Strict walk-forward: **10y train / 6m test / 1m step**
- Decision at **close of day _t_**, execution with **T+lag close** (default **T+1**)
- EMA-slope + momentum regime
- Confidence shaping → volatility targeting → **friction- & impact-adjusted fractional Kelly**
- ATR(14) hard stop + trailing stop + timeout exits
- Deterministic turnover-based linear cost + square-root market impact
- Canonical OOS stitching rule: **FIRST_STEP_ONLY** (non-overlapping OOS)
- Evaluation:
  - performance metrics
  - Newey–West (HAC) regression vs LBMA spot
  - bootstrap Sharpe confidence intervals
  - SPA / White Reality Check
- Capacity analysis via growth curve in leverage space and AUM mapping using participation vs ADV

---

## Data policy (important)

This repository **does not ship proprietary market data**.

All experiments assume a **user-provided CME Gold (GC) futures continuous series**.
A **reference data schema and build pipeline** are provided to ensure reproducibility.

---

## 1) Environment

Python **3.11** recommended (3.10 acceptable).

Create environment and install dependencies:

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r ftf_repro/requirements.txt
Run tests:

pytest -q
2) Data format (inputs)
2.1 Contract bars (per contract)
One file per contract (CSV or Parquet).

Required columns:

close (or configured data.price_col)

high (data.high_col)

low (data.low_col)

Optional:

open (data.open_col)

volume (data.volume_col)

adv (data.adv_col) — contracts/day

Index / date column:

Daily dates

Timezone-naive, normalized to midnight

2.2 Contract metadata
Single CSV or Parquet file with at least:

contract (string; must match filename stem)

fnd (first notice date)

2.3 LBMA spot (optional, benchmark only)
CSV or Parquet with:

date column

price column (default: price)

Used only for regression benchmarking, never for trading decisions.

3) Pipeline: build continuous futures
Build a continuous front-month GC series, rolling 2 business days before FND:

python ftf_repro/scripts/01_build_data.py \
  --contracts_dir /path/to/contracts/ \
  --metadata_path /path/to/contract_metadata.parquet \
  --out_dir ftf_repro/data/processed
Outputs:

gc_continuous.parquet — continuous OHLC (+ optional vol / adv)

active_contract.parquet

roll_table.parquet

validation_report.json

gc_continuous.parquet is treated as the immutable source for all experiments.

4) Run baseline FAST walk-forward OOS
Run the baseline configuration:

python ftf_repro/scripts/02_run_fast_oos.py \
  --config ftf_repro/configs/base_fast.yaml \
  --processed_path ftf_repro/data/processed/gc_continuous.parquet \
  --out_dir ftf_repro/reports/base_fast
Key outputs
config_snapshot.yaml — frozen parameters

reports/oos_daily.parquet — stitched daily out-of-sample log

reports/oos_summary.json — performance summary

artifacts/anchors/<anchor_date>/... — per-anchor frozen params and logs

Timing convention (critical)
w_target[t]: decision-time target at close of day t

w_exec[t] = w_target[t - exec_lag] (default exec_lag = 1)

P&L attribution:

gross_ret[t] = w_exec[t-1] * r[t]

costs charged on executed turnover: |w_exec[t] - w_exec[t-1]|

net_ret[t] = gross_ret[t] - costs[t]

OOS stitching (critical)
Default: FIRST_STEP_ONLY

Ensures non-overlapping, canonical OOS evaluation

5) Robustness scripts
These scripts are not part of daily iteration.
They are used to validate that performance is not an artifact of ideal assumptions.

5.1 Latency sensitivity
python ftf_repro/scripts/03_latency.py \
  --config ftf_repro/configs/base_fast.yaml \
  --grid ftf_repro/configs/grids/latency_grid.yaml \
  --processed_path ftf_repro/data/processed/gc_continuous.parquet \
  --out_dir ftf_repro/reports/latency_grid
Tests T+0 / T+1 / T+2 execution delay robustness.

5.2 Cost & impact stress grid
python ftf_repro/scripts/04_cost_impact.py \
  --config ftf_repro/configs/base_fast.yaml \
  --grid ftf_repro/configs/grids/cost_impact_grid.yaml \
  --processed_path ftf_repro/data/processed/gc_continuous.parquet \
  --out_dir ftf_repro/reports/cost_impact_grid
Evaluates Sharpe decay under scaled linear cost and market impact.

5.3 SPA / White Reality Check
python ftf_repro/scripts/05_spa.py \
  --config ftf_repro/configs/base_fast.yaml \
  --grid ftf_repro/configs/grids/spa_grid.yaml \
  --processed_path ftf_repro/data/processed/gc_continuous.parquet \
  --out_dir ftf_repro/reports/spa
Final statistical validation against data-snooping bias.

6) Capacity analysis
Requires adv in the processed continuous dataset.

python ftf_repro/scripts/06_capacity.py \
  --run_dir ftf_repro/reports/base_fast \
  --out_dir ftf_repro/reports/capacity
Outputs:

growth curve in leverage space

AUM mapping under a participation cap (default 1%)

7) Reporting
Generate a compact report bundle:

python ftf_repro/scripts/07_report.py \
  --run_dir ftf_repro/reports/base_fast \
  --out_dir ftf_repro/reports/report
With LBMA spot regression:

python ftf_repro/scripts/07_report.py \
  --run_dir ftf_repro/reports/base_fast \
  --lbma_path /path/to/lbma_spot.parquet \
  --out_dir ftf_repro/reports/report
8) Notes / design choices
Calendar: NYSE-like business calendar (US Federal holidays)

ATR: simple rolling-mean ATR(14), not Wilder smoothing

Stops:

triggered at close t

baseline exit via exec_lag (T+1)

alternative fill policies configurable

Trainer:

FIXED: canonical constants

GRID: training-only grid search

objective: best train net Sharpe

tie-breaker: lower turnover

License / disclaimer
This repository is research and reproduction code only.

It is not investment advice.
No guarantees are made regarding correctness, performance, or suitability.
You are responsible for validating data quality, assumptions, execution, and regulatory compliance.
